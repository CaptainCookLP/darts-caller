<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>autodarts-caller</title>
    <style>
        .success{
            color: greenyellow;
        }
        .failure{
            color: red;
        }
        body{
            text-align: center;
            background-color: black;
            color: white
        }
        button{
            width: 100%;
            height: 100px;
            font-size: 50pt;
            background-color: orangered;
            color: white;
        }
    </style>
</head>

<body>
    <button id="button">Click me to start calling!</button>
    <audio id="audio" preload="auto"></audio>
    <h1 id="status" style="visibility:hidden;">Disconnected!</h1>
    <h1 id="last-call" style="visibility:hidden;">Waiting for calls ..</h1>

    <script>
        let socket;
        let reconnectInterval = 1000; 
        const audio = document.getElementById('audio');
        const button = document.getElementById('button');
        const state = document.getElementById('status');
        const lastCall = document.getElementById('last-call');
        const soundCache = {};
        const soundQueue = [];
        let isPlaying = false;
        button.addEventListener('click', onButtonClick);


        function onButtonClick() {
            audio.load();
            //playSound("start");
            button.style.visibility='hidden'; 
            state.style.visibility='visible'; 
            lastCall.style.visibility='visible'; 
            setupWebSocketConnection();            
        }

        function addToQueue(data) {
            soundQueue.push(data);
            if (!isPlaying) {
                playNextSound();
            }
        }

        async function playNextSound() {
            if (soundQueue.length === 0) {
                isPlaying = false;
                return;
            }
            // isPlaying = true;
            const data = soundQueue.shift();
            await playSound(data);
            playNextSound();
        }

        function setupWebSocketConnection() {
            socket = new WebSocket("ws://{{ host }}:{{ ws_port }}");
            socket.onopen = function() {
                console.log("Socket: connected!");
                state.innerText = "CONNECTED!";
                state.classList = "success";
            };
            socket.onclose = function() {
                console.log("Socket: disconnected!");
                state.innerText = "DISCONNECTED!";
                state.classList = "failure";
                setTimeout(setupWebSocketConnection, reconnectInterval);
            };
            socket.onmessage = function(event) {
                let data = JSON.parse(event.data);
                if (data.event === "mirror") {
                    // playSound(data);
                    addToQueue(data);
                }
            };
        }
        
        async function loadSound(file) {
            // if (soundCache[file]) {
            //     return soundCache[file];
            // }
            const response = await fetch(`/sounds/${file}`);
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            soundCache[file] = url;
            return url;
        }

        async function playSound(data) {
            console.log("Play sound: ", data.file);
            lastCall.innerText = "Play: " + unescape(data.file);

            function isAudioPlaying() {
                audioElement = document.getElementById('audio');
                return !audioElement.paused && audioElement.readyState >= HTMLMediaElement.HAVE_FUTURE_DATA;
            }

            async function waitForAudioEnd() {
                return new Promise(async (resolve) => {
                    while (isAudioPlaying()) {
                        await new Promise((r) => setTimeout(r, 10));
                    }
                    resolve();
                });
            }

            try {
                if (data.wait = true || data.wait == "true") {
                    await waitForAudioEnd();
                }
                const soundUrl = await loadSound(data.file);
                audio.src = soundUrl;
                await audio.play();
            } catch (e) {
                console.log("playback-error: ", e);
            }
        }

        // window.onload = function() {
        //     setupWebSocketConnection();
        // };
    </script>

</body>
</html>