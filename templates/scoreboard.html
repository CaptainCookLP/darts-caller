<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Patua+One&display=swap">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="/static/css/style.css?v=1.0.0">
    <title>Scoreboard</title>
</head>

<body>
    <h1 id="status">Disconnected!</h1>

    <button onclick="toggleStatsTable()">Toggle Stats Table</button>
	<button onclick="toggleAverageTable()">Toggle Average Table</button>
	<!-- <button onclick="toggleArrow()">Toggle Arrow Position</button> -->
	<button onclick="toggleArrowText()">180</button>
	<button onclick="toggleCheckout1()">Checkout 1</button>
	<button onclick="toggleCheckout2()">Checkout 2</button>

    <div id="scoreboard" class="container">

    <script>
        let socket;
        let reconnectInterval = 1000; 
        let currentMatch;

        const state = document.getElementById('status');
        const scoreboard = document.getElementById('scoreboard');


        function buildScoreboard(message) {

            const hasSets = message.hasOwnProperty('sets');
            const headerHtml = `
                <th style="width:47%;text-align: left;">First to ${hasSets ? message.sets : message.legs} </th>
                ${hasSets ? '<th style="width:14%">Sets</th>' : ''}
                <th style="width:14%">Legs</th>
                <th style="width:14%"></th>
            `;

            const playerHtml = message.players.map((player, index) => `
                <tr class="players">
                    <td class="player" data-label="Player">${player.name}</td>
                    ${hasSets ? `<td class="sets" data-label="Sets">${message.scores[index].sets}</td>` : ''}
                    <td class="legs" data-label="Legs">${message.scores[index].legs}</td>
                    <td class="pointsLeft" data-label="Points Left">${message.gameScores[index]}</td>
                    <td class="arrow" id="arrow${index + 1}" style="visibility: ${index === message.player ? 'visible' : 'hidden'};">&#x25c4;</td>
                </tr>
            `).join('');

            const statsHtml = message.players.map((player, index) => `
                <tr class="backWhite">
                    <td>${message.stats[index].plus100}</td>
                    <td>${message.stats[index].plus140}</td>
                    <td>${message.stats[index].total180}</td>
                </tr>
            `).join('');

            const maxDarts = 9;
            const totalScore = 501;
            const currentPlayer = message.players[message.player];
            const dartsThrown = message.stats[currentPlayer.index].dartsThrown;
            const remainingScore = message.gameScores[currentPlayer.index];
            const gameType = message.settings.baseScore;
            const isNineDartPossible = gameType === totalScore && dartsThrown < maxDarts && remainingScore <= (maxDarts - dartsThrown) * 60;
            // let checkoutType = 0;
            // if(message.state.checkoutGuide && message.turns[0].hasOwnProperty('throws') && message.turns[0].throws != null && message.turns[0].throws.length > 0){
            //     checkoutType = 1; // es gab einen 
            // }
            // console.log(checkoutStyle);

  
            const checkoutHtml = `
                <table class="checkout animate__animated animate__fadeOutRight" id="checkout${message.player + 1}" style="display:none;bottom:${40 + (message.players.length - message.player) * 50}px">
                    <tr>
                        ${isNineDartPossible ? '<th class="darter">9</th>' : ''}
                        ${message.state.checkoutGuide ? message.state.checkoutGuide.map(field => `<th>${field.name}</th>`).join('') : ''}
                    </tr>
                </table>
            `;

            const averagesHtml = message.players.map((player, index) => `
                <tr class="backWhite">
                    <td id="player${index + 1}average">${message.stats[index].average.toFixed(2)}</td>
                </tr>
            `).join('');


            scoreboard.innerHTML =
                `
                <table class="basicTable">
                    <thead>
                        <tr class="header">
                            ${headerHtml}
                        </tr>
                    </thead>
                    <tbody>
                        ${playerHtml}
                    </tbody>
                    <tfoot>
                        <tr class="footer">
                            <td class="game" colspan="${hasSets ? '2' : '1'}">2023 World Championship Final</td>
                            <td class="ad" colspan="2">Sky Sports</td>
                        </tr>
                    </tfoot>
                </table>

                <table class="statsTable animate__animated animate__fadeOutRight" id="statsTable" style="display: none;">
                    <tr class="header">
                        <th style="width:33%">100+</th>
                        <th style="width:33%">140+</th>
                        <th style="width:33%">180</th>
                    </tr>
                    ${statsHtml}
                </table>

                <table class="averageTable animate__animated animate__fadeOutRight" id="averageTable" style="display: none;">
                    <tr class="header">
                        <th>Averages</th>
                    </tr>
                    ${averagesHtml}
                    <tr class="footer">
                        <td style="color:black">Leg</td>
                    </tr>
                </table>

                ${checkoutHtml}
                `;

                // && checkoutStyle === 'none'
                if(message.state.checkoutGuide){
                    toggleCheckout(message.player + 1)
                }
        }

        function toggleCheckout(playerId) {
            var checkout = document.getElementById("checkout" + playerId);
            if (checkout.style.display === "none" || checkout.style.display === "") {
                checkout.classList.remove("animate__fadeOutRight");
                checkout.classList.add("animate__fadeInRight");
                checkout.style.display = "table";
            } else {
                checkout.classList.remove("animate__fadeInRight");
                checkout.classList.add("animate__fadeOutRight");

                checkout.addEventListener("animationend", function () {
                    checkout.style.display = "none";
                }, { once: true });
            }
        }


        function handleMessage(message) {
            console.log(message);
            if(currentMatch != message['id']){
                buildScoreboard(message);
            }      
        }

        function setupWebSocketConnection() {
            socket = new WebSocket("ws://{{ host }}:{{ ws_port }}");
            socket.onopen = function() {
                console.log("Socket: connected!");
                state.innerText = "CONNECTED!";
                state.classList = "success";
            };
            socket.onclose = function() {
                console.log("Socket: disconnected!");
                state.innerText = "DISCONNECTED!";
                state.classList = "failure";
                setTimeout(setupWebSocketConnection, reconnectInterval);
            };
            socket.onmessage = function(event) {
                let data = JSON.parse(event.data);
                handleMessage(data);
            };
        }

        document.addEventListener("DOMContentLoaded", function() {
            setupWebSocketConnection();  
        });
    </script>

    <script type="text/javascript" src="/static/js/animation.js?v=1.0.0"></script>
</body>
</html>